name: AI PR Review with GitHub Copilot

on:
  pull_request:
    types: [opened, synchronize]
    # Only run on Dependabot PRs
    branches: ['**']

jobs:
  github-copilot-review:
    if: contains(github.event.pull_request.title, 'chore(deps)') || github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Dependency Changes
        id: analyze
        run: |
          echo "🔍 Analyzing dependency changes..."
          
          # Get changed files
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          
          # Extract dependency changes
          if grep -q "Versions.kt\|build.gradle\|dependencies" changed_files.txt; then
            echo "dependency_changes=true" >> $GITHUB_OUTPUT
            
            # Get the diff for analysis
            git diff HEAD~1 HEAD -- "*.gradle" "*.kt" > dependency_diff.txt
            
            # Extract version changes with more detail
            git diff HEAD~1 HEAD | grep -E "^\+.*const val.*=|^\-.*const val.*=" > version_changes.txt || true
            
            # Parse specific dependency updates
            git diff HEAD~1 HEAD buildSrc/src/main/kotlin/io.customer/android/Versions.kt | \
              grep -E "^\+.*const val.*=|^\-.*const val.*=" | \
              sed 's/[+-].*const val \([A-Z_]*\) = "\([^"]*\)".*/\1:\2/' > parsed_changes.txt || true
          else
            echo "dependency_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Dependency Analysis Context
        if: steps.analyze.outputs.dependency_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Double-check this is a dependency update PR
            const isDependencyPR = (
              '${{ github.actor }}' === 'dependabot[bot]' || 
              '${{ github.event.pull_request.title }}'.includes('chore(deps)') ||
              '${{ github.event.pull_request.title }}'.toLowerCase().includes('dependency') ||
              '${{ github.event.pull_request.title }}'.toLowerCase().includes('deps')
            );
            
            if (!isDependencyPR) {
              console.log('🚫 Not a dependency PR - skipping analysis');
              return;
            }
            
            console.log('✅ Confirmed dependency PR - posting analysis context');
            
            // Read the dependency changes for context
            const fs = require('fs');
            const changedFiles = fs.readFileSync('changed_files.txt', 'utf8');
            const versionChanges = fs.readFileSync('version_changes.txt', 'utf8');
            
            // Generate analysis questions based on detected changes
            const generateAnalysisQuestions = (changes) => {
              const questions = [];
              
              // Component-specific questions based on detected dependencies
              if (changes.includes('Firebase') || changes.includes('firebase')) {
                questions.push('How does this Firebase update affect push notifications in Customer.io SDK?');
              }
              if (changes.includes('Compose') || changes.includes('compose')) {
                questions.push('What Compose changes might break our in-app messaging UI?');
              }
              if (changes.includes('Kotlin') || changes.includes('kotlin')) {
                questions.push('Check Kotlin version compatibility across all dependencies in our SDK');
              }
              if (changes.includes('Retrofit') || changes.includes('retrofit') || changes.includes('OkHttp') || changes.includes('okhttp')) {
                questions.push('Analyze networking library changes impact on our API communication');
              }
              if (changes.includes('Redux') || changes.includes('redux')) {
                questions.push('Analyze Redux changes affecting our in-app messaging state management');
              }
              if (changes.includes('Segment') || changes.includes('segment')) {
                questions.push('Check if this Segment update affects our data pipeline architecture');
              }
              if (changes.includes('Android Gradle Plugin') || changes.includes('AGP')) {
                questions.push('Verify AGP compatibility with our build configuration and Kotlin version');
              }
              if (changes.includes('Coroutines') || changes.includes('coroutines')) {
                questions.push('Check coroutines compatibility with our asynchronous programming implementation');
              }
              if (changes.includes('Timber') || changes.includes('timber')) {
                questions.push('Analyze logging changes impact on debugging and error tracking');
              }
              
              // Always include general analysis
              questions.unshift('Review AGENTS.md for project context, then analyze these dependency updates for Customer.io Android SDK impact');
              
              return questions;
            };
            
            const analysisQuestions = generateAnalysisQuestions(versionChanges + changedFiles);
            const questionsList = analysisQuestions.map(q => `- ${q}`).join('\n');
            
            const analysisComment = `## 🤖 Customer.io SDK Dependency Analysis Framework
            
            This PR contains dependency updates that need analysis for Customer.io Android SDK impact.
            
            ### 🎯 Key Analysis Questions:
            ${questionsList}
            
            ### 📋 Analysis Checklist:
            
            #### 🔍 **Step 1: Review Project Context**
            - [ ] Read **AGENTS.md** for complete Customer.io SDK architecture and guidelines
            - [ ] Check **buildSrc/src/main/kotlin/io.customer/android/Versions.kt** for current versions
            - [ ] Understand Customer.io SDK components affected
            
            #### ⚙️ **Step 2: Compatibility Analysis**
            - [ ] **Kotlin Compatibility**: Does this work with Kotlin 1.8.21?
            - [ ] **Android API Levels**: Compatible with min SDK 21, target SDK 33+?
            - [ ] **Dependency Conflicts**: Any conflicts with other dependencies?
            
            #### 🧩 **Step 3: Customer.io SDK Impact**
            - [ ] **Push Notifications**: Impact on Firebase integration and messaging
            - [ ] **In-App Messaging**: Effects on Compose UI components and Redux state
            - [ ] **Event Tracking**: Changes affecting analytics and data pipeline
            - [ ] **Network Layer**: Impact on Retrofit + OkHttp API communication
            - [ ] **Background Processing**: Effects on async operations and coroutines
            - [ ] **Sample Apps**: Compatibility with both Kotlin Compose and Java layouts
            
            #### 📚 **Step 4: Review Resources**
            - [ ] Check dependency changelog/release notes for breaking changes
            - [ ] Review migration guides if available
            - [ ] Test critical Customer.io SDK functionality
            
            ### 🚀 **How to Proceed:**
            
            1. **Manual Review**: Use the checklist above to analyze the changes
            2. **Ask Questions**: Comment with specific concerns about Customer.io SDK impact
            3. **Test Locally**: Focus testing on the components identified above
            4. **Reference Documentation**: Use AGENTS.md as your guide for Customer.io SDK architecture
            
            ---
            **💡 Tip**: This framework helps ensure dependency updates don't break Customer.io SDK functionality. Focus your review on the specific components that could be affected by these changes.`;
            
            // Post the analysis framework
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: analysisComment
            }); 